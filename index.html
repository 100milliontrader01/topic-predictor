<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hit or Flop? | Gemini AI Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #020617;
            background-image: 
                radial-gradient(at 0% 0%, rgba(30, 58, 138, 0.3) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(126, 34, 206, 0.2) 0, transparent 50%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideUp 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .insight-card {
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid transparent;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .insight-card.positive { border-left-color: #10b981; background: rgba(16, 185, 129, 0.05); }
        .insight-card.negative { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        
        .suggestion-box {
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SVG Circle Animation */
        .gauge-circle {
            transition: stroke-dashoffset 1s ease-out, color 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        #customAlert {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 1rem 2rem;
            border-radius: 12px;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }
        
        #infoModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 50;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">

    <div id="customAlert" class="text-sm font-medium"></div>

    <!-- Info Modal -->
    <div id="infoModal" onclick="toggleInfo(false)">
        <div class="glass max-w-lg w-full p-8 rounded-2xl relative" onclick="event.stopPropagation()">
            <button onclick="toggleInfo(false)" class="absolute top-4 right-4 text-slate-400 hover:text-white">Close</button>
            <h2 class="text-2xl font-bold mb-4 text-white">How it Works</h2>
            <div class="space-y-4 text-sm text-slate-300 leading-relaxed">
                <div>
                    <h3 class="text-emerald-400 font-semibold mb-1">1. The Training Phase</h3>
                    <p>When you add titles to Hits and Flops, they are saved locally. This creates a "style profile" unique to your audience.</p>
                </div>
                <div>
                    <h3 class="text-purple-400 font-semibold mb-1">2. The Gemini Brain</h3>
                    <p>The AI compares your new idea against your history to identify patterns (e.g., specific keywords, formats, or tones that succeed for you).</p>
                </div>
                <div>
                    <h3 class="text-yellow-400 font-semibold mb-1">3. Scoring Logic</h3>
                    <ul class="list-disc pl-4 space-y-1 mt-1 text-slate-400">
                        <li><span class="text-emerald-500">Green (7.0+):</span> Strong match with Hits.</li>
                        <li><span class="text-yellow-500">Yellow (4.0-6.9):</span> Uncertain or mixed signals.</li>
                        <li><span class="text-red-500">Red (0-3.9):</span> High risk, matches Flops.</li>
                    </ul>
                </div>
                <div class="pt-4 border-t border-white/10">
                    <h3 class="text-blue-400 font-semibold mb-1">External Hosting</h3>
                    <p>To use this outside of Gemini, you must enter your own API Key from Google AI Studio in the input field at the bottom of the page.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-12 animate-slide relative">
            <button onclick="toggleInfo(true)" class="absolute right-0 top-0 md:top-2 text-slate-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <h1 class="text-5xl font-extrabold tracking-tight mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Hit or Flop?
            </h1>
            <p class="text-slate-400 font-medium text-lg">Analyzes patterns from your best and worst performing videos to predict performance of new ones.</p>
        </header>

        <section class="mb-12 animate-slide">
            <div class="glass rounded-3xl p-8 max-w-3xl mx-auto border-t border-white/20">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
                    <span class="text-purple-400"></span> Analyze Idea
                </h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="predictInput" 
                        class="flex-1 bg-white/5 border border-white/10 rounded-xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-lg" 
                        placeholder="Enter your video title or idea...">
                    <button id="predictBtn" 
                        class="bg-white text-slate-900 font-bold px-8 py-4 rounded-xl hover:bg-purple-100 transition-all active:scale-95 flex items-center justify-center gap-2 min-w-[180px]">
                        <span id="btnText">Score </span>
                        <span id="btnLoader" class="loader hidden"></span>
                    </button>
                </div>
                
                <div id="predictionResult" class="hidden mt-8 p-6 rounded-2xl border transition-all duration-500 glass">
                    <div id="resultContent" class="flex flex-col items-center text-center">
                        <span class="text-xs font-bold uppercase tracking-widest mb-4 text-slate-400">Verdict</span>
                        <h3 id="resultVerdict" class="text-3xl font-black mb-6"></h3>
                        
                        <!-- Radial Gauge -->
                        <div class="relative w-40 h-40 mb-2">
                            <svg class="w-full h-full" viewBox="0 0 128 128">
                                <!-- Background Circle -->
                                <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="10" fill="transparent" />
                                <!-- Progress Circle -->
                                <circle id="scoreCircle" class="gauge-circle" cx="64" cy="64" r="56" stroke="currentColor" stroke-width="10" fill="transparent" stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="gaugeValue" class="text-4xl font-black text-white">0</span>
                                <span class="text-xs text-slate-400 font-bold uppercase mt-1">/ 10</span>
                            </div>
                        </div>

                        <!-- AI Suggestion Box -->
                        <div id="aiSuggestion" class="hidden mt-6 w-full suggestion-box rounded-xl p-4 text-left animate-slide">
                            <div class="flex items-start gap-3">
                                <span class="text-xl font-bold text-indigo-400">Suggestion:</span>
                                <div>
                                    <p id="suggestionText" class="text-white font-medium italic"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 w-full text-left space-y-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-tighter">Strategic Insights</h4>
                            <div id="insightsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid md:grid-cols-2 gap-8 animate-slide">
            <!-- Hits -->
            <div class="glass rounded-3xl p-6 flex flex-col h-[500px]">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-emerald-400">Best Performing Videos</h3>
                    <span id="hitCount" class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-md font-mono">0</span>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="hitEntry" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm focus:ring-1 focus:ring-emerald-500" placeholder="Add successful video...">
                    <button id="addHitBtn" class="bg-emerald-500 hover:bg-emerald-400 text-white p-2 rounded-lg font-bold">Add</button>
                </div>
                <ul id="hitsList" class="space-y-2 overflow-y-auto custom-scrollbar flex-1"></ul>
            </div>

            <!-- Flops -->
            <div class="glass rounded-3xl p-6 flex flex-col h-[500px]">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-red-400">Worst Performing Videos</h3>
                    <span id="flopCount" class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-md font-mono">0</span>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="flopEntry" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm focus:ring-1 focus:ring-red-500" placeholder="Add unsuccessful video...">
                    <button id="addFlopBtn" class="bg-red-500 hover:bg-red-400 text-white p-2 rounded-lg font-bold">Add</button>
                </div>
                <ul id="flopsList" class="space-y-2 overflow-y-auto custom-scrollbar flex-1"></ul>
            </div>
        </div>

        <!-- Footer / API Key Setting -->
        <footer class="mt-12 text-center pb-8 animate-slide">
            <div class="inline-flex items-center gap-3 bg-white/5 border border-white/10 px-4 py-2 rounded-full">
                <label for="apiKeyInput" class="text-xs font-bold text-slate-500 uppercase">External API Key:</label>
                <input type="password" id="apiKeyInput" class="bg-transparent border-none focus:outline-none text-xs text-white placeholder:text-slate-600 w-48" placeholder="Enter key for local hosting...">
            </div>
            <p class="text-[10px] text-slate-600 mt-2">Key is saved only in your browser's local storage.</p>
        </footer>
    </div>

    <script>
        // API key logic
        const apiKey = ""; 
        let currentApiKey = apiKey;
        let appData = { hits: [], flops: [] };

        function toggleInfo(show) {
            const modal = document.getElementById('infoModal');
            modal.style.display = show ? 'flex' : 'none';
        }

        function showAlert(msg, type = 'info') {
            const el = document.getElementById('customAlert');
            if (!el) return;
            el.innerText = msg;
            el.style.display = 'block';
            el.style.borderColor = type === 'error' ? '#ef4444' : 'rgba(255,255,255,0.1)';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function init() {
            const stored = localStorage.getItem('geminiPredictorData');
            if (stored) { 
                try { 
                    const parsed = JSON.parse(stored);
                    appData = {
                        hits: Array.isArray(parsed.hits) ? parsed.hits : [],
                        flops: Array.isArray(parsed.flops) ? parsed.flops : []
                    };
                } catch (e) {
                    appData = { hits: [], flops: [] };
                } 
            }

            const savedKey = localStorage.getItem('gemini_external_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                if (!apiKey) currentApiKey = savedKey;
            }

            renderLists();
            
            document.getElementById('predictBtn').onclick = handleGeminiPrediction;
            document.getElementById('addHitBtn').onclick = () => addTopic('hits');
            document.getElementById('addFlopBtn').onclick = () => addTopic('flops');
            document.getElementById('apiKeyInput').onchange = (e) => {
                const val = e.target.value.trim();
                localStorage.setItem('gemini_external_key', val);
                if (!apiKey) currentApiKey = val;
                showAlert("API Key updated locally.");
            };

            document.getElementById('hitEntry').onkeypress = e => { if(e.key === 'Enter') addTopic('hits'); };
            document.getElementById('flopEntry').onkeypress = e => { if(e.key === 'Enter') addTopic('flops'); };
        }

        function save() {
            localStorage.setItem('geminiPredictorData', JSON.stringify(appData));
            renderLists();
        }

        function addTopic(type) {
            const inputId = type === 'hits' ? 'hitEntry' : 'flopEntry';
            const input = document.getElementById(inputId);
            if (!input) return;
            const val = input.value.trim();
            if (val) {
                appData[type].unshift(val);
                input.value = '';
                save();
            }
        }

        window.removeTopic = (type, index) => { 
            if (appData[type]) {
                appData[type].splice(index, 1); 
                save(); 
            }
        };

        function renderLists() {
            const hitsList = document.getElementById('hitsList');
            const hitCount = document.getElementById('hitCount');
            if (hitsList) {
                hitsList.innerHTML = '';
                appData.hits.forEach((topic, i) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white/5 px-4 py-3 rounded-xl border border-white/5 group mb-2 animate-slide';
                    li.innerHTML = `<span class="text-sm truncate">${topic}</span><button onclick="removeTopic('hits', ${i})" class="text-slate-500 hover:text-red-400 transition-colors px-2 font-bold">Remove</button>`;
                    hitsList.appendChild(li);
                });
            }
            if (hitCount) hitCount.innerText = appData.hits.length;

            const flopsList = document.getElementById('flopsList');
            const flopCount = document.getElementById('flopCount');
            if (flopsList) {
                flopsList.innerHTML = '';
                appData.flops.forEach((topic, i) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white/5 px-4 py-3 rounded-xl border border-white/5 group mb-2 animate-slide';
                    li.innerHTML = `<span class="text-sm truncate">${topic}</span><button onclick="removeTopic('flops', ${i})" class="text-slate-500 hover:text-red-400 transition-colors px-2 font-bold">Remove</button>`;
                    flopsList.appendChild(li);
                });
            }
            if (flopCount) flopCount.innerText = appData.flops.length;
        }

        async function callGemini(prompt) {
            const activeKey = currentApiKey || ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`;
            
            const systemPrompt = `You are a strict Content Strategist. Analyze the user's video idea against their history.
            Strictly output JSON with this schema:
            {
                "verdict": "string",
                "confidence_score": number,
                "rating_text": "string (strictly in format: '8.5/10')",
                "insights": [{"type": "positive"|"negative", "text": "string"}],
                "suggested_improvement": "string"
            }`;

            let retries = 0;
            const backoff = [1000, 2000, 4000];

            while (retries < 5) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (e) {
                    if (retries === 4) throw e;
                    await new Promise(r => setTimeout(r, backoff[retries] || 8000));
                    retries++;
                }
            }
        }

        async function handleGeminiPrediction() {
            const input = document.getElementById('predictInput');
            const topic = input?.value.trim();
            if (!topic) return;

            if (appData.hits.length === 0 && appData.flops.length === 0) {
                showAlert("Add some training data first!", "error");
                return;
            }

            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            btnText.innerText = "Thinking...";
            loader.classList.remove('hidden');

            try {
                const result = await callGemini(`Topic: "${topic}". My Hits: ${appData.hits.join(', ')}. My Flops: ${appData.flops.join(', ')}`);
                displayResult(result);
            } catch (e) {
                console.error(e);
                showAlert("AI Connection failed. Check your API key.", "error");
            } finally {
                btnText.innerText = "Score";
                loader.classList.add('hidden');
            }
        }

        function displayResult(res) {
            const panel = document.getElementById('predictionResult');
            const verdictEl = document.getElementById('resultVerdict');
            const gaugeValueEl = document.getElementById('gaugeValue');
            const circle = document.getElementById('scoreCircle');
            const insightsList = document.getElementById('insightsList');
            const suggestionBox = document.getElementById('aiSuggestion');
            const suggestionText = document.getElementById('suggestionText');

            // Reset UI state before showing new result
            panel.classList.remove('hidden');
            
            // Set initial state for animation
            const circumference = 351.86; // 2 * pi * 56
            circle.style.strokeDashoffset = circumference;
            
            verdictEl.innerText = res.verdict;
            
            // Parse rating (e.g., "8.5/10") or fallback to score
            let displayScore = "0.0";
            let score = Math.max(0, Math.min(100, res.confidence_score || 0));

            // Try to extract numeric part from rating_text like "8.5/10"
            const ratingMatch = (res.rating_text || "").match(/([\d\.]+)/);
            if (ratingMatch) {
                displayScore = ratingMatch[1];
                // Recalculate score percentage if needed based on the text
                const val = parseFloat(displayScore);
                if (!isNaN(val)) score = val * 10;
            } else {
                displayScore = (score / 10).toFixed(1);
            }
            
            gaugeValueEl.innerText = displayScore;

            // Determine color based on score thresholds
            let colorHex = "#ef4444"; // Red
            if (score >= 40) colorHex = "#eab308"; // Yellow
            if (score >= 70) colorHex = "#10b981"; // Green
            
            // Apply color
            circle.style.color = colorHex;

            // Animate offset
            // dashoffset = circumference - (percent * circumference)
            const offset = circumference - (score / 100) * circumference;
            setTimeout(() => { 
                circle.style.strokeDashoffset = offset;
            }, 50);

            insightsList.innerHTML = (res.insights || []).map(i => `
                <div class="insight-card ${i.type === 'positive' ? 'positive' : 'negative'}">
                    <p class="text-sm text-slate-200">${i.text}</p>
                </div>
            `).join('');

            if (res.suggested_improvement) {
                suggestionBox.classList.remove('hidden');
                suggestionText.innerText = res.suggested_improvement;
            } else {
                suggestionBox.classList.add('hidden');
            }
            
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        window.onload = init;
    </script>
</body>
</html>


